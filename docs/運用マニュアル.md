# 予約管理システム連携ツール 運用マニュアル

## 1. はじめに

本マニュアルは予約管理シート(Excel)とSupabaseデータベースの自動同期ツールの運用方法を説明するものです。

**対象システム**: 予約管理シート連携ツール  
**バージョン**: 1.0.0  
**適用日**: YYYY年MM月DD日  
**作成者**: XXXX

## 2. システム概要

本システムは以下の主要機能を提供します：

1. 共有サーバー上の予約管理Excel (*.xlsm) を定期的に監視
2. 更新があったファイルからCH列（夜間）データを抽出
3. 前回データとの差分を計算
4. Supabaseデータベースへ差分データを反映
5. 処理結果をCSVファイルに証跡として保存
6. LINE WORKS Botへ処理結果を通知

## 3. 運用環境

### 3.1 ハードウェア構成

- 運用サーバー: 社内クライアントPC (Windows 10/11 Pro)
- CPU: Core i5 相当以上
- メモリ: 8GB以上
- ディスク: SSD 128GB以上
- ネットワーク: 社内LAN (Ethernet接続推奨)

### 3.2 ソフトウェア構成

- OS: Windows 10/11 Pro (64bit)
- .NET Runtime: .NET 6.0以上
- タスクスケジューラ: Windowsタスクスケジューラ
- 認証: OS資格情報マネージャーを使用

### 3.3 外部接続先

- ファイル共有サーバー: 
  - \\192.168.200.20\全社共有\SS予約表\2025年\千葉\いいいい\【いいいい】2025年_SS予約表_*.xlsm
  - \\192.168.200.20\全社共有\SS予約表\2025年\埼京A2\ふふふふ\【ふふふふ】2025年_SS予約表_*.xlsm
  - \\192.168.200.20\全社共有\SS予約表\2025年\埼京B\みみみ\【みみみ】2025年_SS予約表_*.xlsm
- Supabase: https://[project-id].supabase.co
- LINE WORKS Bot: LINE WORKS管理コンソール設定済Bot

## 4. インストール・初期設定

### 4.1 インストール手順

1. インストールパッケージ (ReservationSync-Setup.msi) を実行
2. インストール先を指定 (デフォルト: C:\Program Files\ReservationSync)
3. インストール完了後、初期設定ツールが自動起動

### 4.2 初期設定手順

1. 「初期設定」画面で以下の情報を入力:
   - Supabase URL (環境変数へ保存)
   - Supabase API Key (環境変数へ保存)
   - LINE WORKS Client ID (環境変数へ保存)
   - LINE WORKS Bot ID (環境変数へ保存)
   - LINE WORKS JWT秘密鍵 (OS資格情報マネージャーへ保存)

2. 「設定ファイル編集」タブで以下の情報を確認・編集:
   - 監視対象ネットワークパス
   - 実行スケジュール (デフォルト: 10時±15分、18時±15分)
   - Excel関連設定 (シート名、対象列など)

3. 「接続テスト」ボタンで各外部システムへの接続テスト実行

4. 「スケジュール設定」ボタンでWindowsタスクスケジューラに登録

### 4.3 権限設定

1. サービス実行アカウントに以下の権限を付与:
   - ネットワーク共有フォルダへの読み取り権限
   - ローカルフォルダへの読み書き権限
   - 環境変数アクセス権限
   - OS資格情報マネージャーアクセス権限

2. ファイアウォール設定:
   - 外部通信許可 (Supabase、LINE WORKS API)

## 5. 日常運用手順

### 5.1 定期実行の確認

- 実行スケジュール:
  - 午前実行: 10:00 ±15分 (Windowsタスクスケジューラ)
  - 午後実行: 18:00 ±15分 (Windowsタスクスケジューラ)

- 実行ステータス確認方法:
  1. Windowsタスクスケジューラを開く
  2. 「ReservationSync」タスクの「最終実行結果」を確認
  3. 証跡フォルダ (C:\ProgramData\ReservationSync\proof) の最新ファイルを確認

### 5.2 LINE通知の確認

- 正常実行時:
  - LINE WORKS Botから処理結果サマリが通知されます
  - フォーマット: 「予約データ同期: 新規XX件、変更YY件、削除ZZ件 (処理時間: A分B秒)」

- エラー発生時:
  - エラー種別と発生箇所が通知されます
  - フォーマット: 「【警告】予約データ同期エラー: [エラー内容] (時刻: HH:MM)」

### 5.3 証跡ファイルの確認

- 保存場所: C:\ProgramData\ReservationSync\proof
- ファイル名: YYYYMMDD_HHmmss_proof.csv
- 内容確認方法: Excel等でCSVファイルを開き内容を確認
- 保存期間: 6ヶ月間保存 (自動ローテーション)

### 5.4 状態ファイルの確認

- 保存場所: C:\ProgramData\ReservationSync\state
- ファイル名: YYYYMMDD_HHmmss.json
- 用途: 次回差分計算用の現状データ保存
- 保存期間: 最新5世代のみ保持 (古いものは自動削除)

## 6. 異常時対応手順

### 6.1 ネットワークエラー発生時

1. エラー内容確認:
   - Windowsイベントログ (アプリケーションログ - ソース: ReservationSync)
   - 最新のログファイル (C:\ProgramData\ReservationSync\logs)

2. 対応手順:
   - ネットワーク接続状態を確認
   - 共有フォルダへのアクセス権限を確認
   - ネットワーク復旧後、手動実行で動作確認
   - 問題解決しない場合はシステム管理者へ連絡

### 6.2 Excelファイル処理エラー発生時

1. エラー内容確認:
   - エラーログファイル (C:\ProgramData\ReservationSync\logs)
   - LINE通知内容

2. 対応手順:
   - 該当Excelファイルの形式・内容を確認
   - シート名が正しいか確認 (デフォルト: 「SS予約表」)
   - CH列（夜間）に異常データがないか確認
   - 修正後、手動実行で動作確認

### 6.3 Supabase接続エラー発生時

1. エラー内容確認:
   - エラーログファイル (C:\ProgramData\ReservationSync\logs)
   - LINE通知内容

2. 対応手順:
   - インターネット接続を確認
   - 環境変数 (SUPABASE_URL, SUPABASE_KEY) が正しく設定されているか確認
   - Supabaseサービスの稼働状況を確認
   - 問題解決後、手動実行で動作確認

### 6.4 LINE WORKS API連携エラー発生時

1. エラー内容確認:
   - エラーログファイル (C:\ProgramData\ReservationSync\logs)

2. 対応手順:
   - インターネット接続を確認
   - 環境変数 (LINE_WORKS_CLIENT_ID, LINE_WORKS_BOT_ID) が正しいか確認
   - OS資格情報マネージャーのJWT秘密鍵が有効か確認
   - LINE WORKS管理コンソールでBot状態を確認
   - 問題解決後、テスト送信機能で動作確認

## 7. 手動実行手順

### 7.1 管理ツールからの実行

1. デスクトップの「ReservationSync管理ツール」を実行
2. 「手動実行」タブを選択
3. 処理対象を選択:
   - 「全拠点処理」: フェーズ1の3拠点ファイルを処理
   - 「個別拠点処理」: 特定拠点のみ処理
4. 「実行」ボタンをクリック
5. 処理結果を画面で確認

### 7.2 コマンドラインからの実行

1. コマンドプロンプトを管理者権限で起動
2. 以下のコマンドを実行:
   ```
   cd C:\Program Files\ReservationSync
   ReservationSync.exe --manual
   ```
3. オプション:
   - `--store <拠点ID>`: 特定拠点のみ処理
   - `--verbose`: 詳細ログ出力
   - `--no-notify`: LINE通知なし
   - `--force`: 差分なしでも証跡生成

## 8. メンテナンス手順

### 8.1 データファイル管理

- 証跡ファイル自動ローテーション:
  - 6ヶ月を超えるファイルは自動削除されます
  - 手動削除: 管理ツール「メンテナンス」タブ→「古い証跡を削除」

- 状態ファイル自動ローテーション:
  - 最新5世代以外は自動削除されます
  - 手動削除: 管理ツール「メンテナンス」タブ→「古い状態ファイルを削除」

### 8.2 ログファイル管理

- ログファイル自動ローテーション:
  - 30日を超えるログは自動削除されます
  - 手動削除: 管理ツール「メンテナンス」タブ→「古いログを削除」

- ログレベル変更:
  - 管理ツール「設定」タブ→「ログレベル」で変更
  - 通常時: Information
  - 障害調査時: Debug
  - 詳細調査時: Trace

### 8.3 バックアップ・リストア

- バックアップ実行:
  1. 管理ツール「メンテナンス」タブ→「構成バックアップ」
  2. バックアップ先を指定
  3. 「バックアップ実行」ボタンをクリック

- リストア実行:
  1. 管理ツール「メンテナンス」タブ→「構成リストア」
  2. バックアップファイルを指定
  3. 「リストア実行」ボタンをクリック
  4. アプリケーション再起動

### 8.4 バージョンアップ

1. 最新インストーラ (ReservationSync-Setup-x.x.x.msi) を取得
2. 管理ツール「メンテナンス」タブ→「構成バックアップ」でバックアップ
3. 現在のサービスを停止: 「サービス停止」ボタン
4. インストーラを実行 (既存設定は引き継がれます)
5. 設定確認: 管理ツール「設定」タブですべての設定を確認
6. サービス開始: 「サービス開始」ボタン
7. 動作確認: 「手動実行」タブでテスト実行

## 9. トラブルシューティング

### 9.1 よくある問題と対処法

| 問題 | 考えられる原因 | 対処法 |
|-----|-------------|------|
| タスクは実行されたが処理結果がない | ファイル変更なし | 証跡ファイルで「変更なし」と記録されているか確認 |
| ファイルを更新したが検出されない | 監視時間外の更新 | 手動実行で確認、次回スケジュール実行を待つ |
| LINE通知が届かない | Bot設定・認証エラー | JWT認証情報を確認、テスト送信で動作確認 |
| 特定拠点のデータだけ同期されない | ファイル形式異常 | 該当拠点のExcelファイル形式を確認 |
| 処理が極端に遅い | ネットワーク遅延 | ネットワーク状態確認、オフピーク時に実行 |

### 9.2 ログ分析

1. ログファイル場所:
   - C:\ProgramData\ReservationSync\logs\ReservationSync_YYYYMMDD.log

2. 主要エラーメッセージと対応:
   - `Failed to access network path`: ネットワーク接続・権限を確認
   - `Excel file format error`: Excelファイル形式を確認
   - `Supabase connection timeout`: インターネット接続を確認
   - `JWT token generation failed`: 認証情報を確認

3. 詳細ログ出力方法:
   - 管理ツール「設定」タブでログレベルをDebugに変更
   - 再現操作実行
   - ログファイル分析

### 9.3 サポート連絡先

- 社内ヘルプデスク: xxx-xxxx-xxxx（内線: xxxx）
- メール: helpdesk@example.com
- 対応時間: 平日 9:00-18:00

連絡時に以下の情報をお伝えください:
- エラー発生日時
- エラーメッセージ内容
- 実施済みの対処法
- 問題の発生頻度

## 10. 付録

### 10.1 用語集

| 用語 | 説明 |
|-----|------|
| Supabase | バックエンドデータベースサービス (PostgreSQL) |
| LINE WORKS | ビジネスコミュニケーションプラットフォーム |
| JWT | JSON Web Token, APIアクセス認証に使用 |
| 証跡ファイル | 処理結果を記録したCSVファイル |
| 状態ファイル | 差分計算用の前回データを保存したJSONファイル |

### 10.2 設定ファイル仕様

設定ファイル (appsettings.json) の詳細仕様は別途「技術仕様書」を参照

### 10.3 関連マニュアル

- システム設計書
- テスト結果報告書
- 障害対応マニュアル（詳細版）

### 10.4 改訂履歴

| 版数 | 日付 | 改訂内容 | 改訂者 |
|-----|------|---------|-------|
| 1.0 | YYYY/MM/DD | 初版作成 | XXXX | 