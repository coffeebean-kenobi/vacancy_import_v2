# 予約管理システム連携ツール インストール手順書

## 1. 前提条件

### 1.1 環境要件

**ハードウェア最低要件**:
- CPU: Intel Core i5 相当以上
- メモリ: 8GB以上
- ディスク: 空き容量10GB以上のSSD
- ネットワーク: 社内LAN接続 (有線推奨)

**ソフトウェア要件**:
- Windows 10 Pro/Enterprise (64bit) / Windows 11 Pro (64bit)
- .NET 6.0 Runtime
- Microsoft Excel (2016以降)
- 管理者権限を持つユーザーアカウント

**サーバー環境**:
- 社内ファイルサーバー: \\192.168.200.20\全社共有\SS予約表\ へのアクセス権限
- インターネット接続: Supabase/LINE WORKSへのアクセス

### 1.2 入手物

- インストールパッケージ: ReservationSync-Setup-1.0.0.msi
- 認証情報シート: 「連携ツール用認証情報.xlsx」(暗号化済み)
- インストール手順書: 本資料

## 2. 事前準備

### 2.1 .NET 6.0 Runtimeのインストール

1. Microsoft公式サイトから .NET 6.0 Runtime デスクトップインストーラをダウンロード
   - URL: https://dotnet.microsoft.com/download/dotnet/6.0
   - 「Run desktop apps」の「Download x64」を選択

2. ダウンロードしたインストーラを実行
   - windowsdesktop-runtime-6.0.x-win-x64.exe を実行
   - 画面の指示に従ってインストール

3. インストール確認
   - コマンドプロンプトを開き、以下のコマンドを実行
   ```
   dotnet --info
   ```
   - .NET Runtime 6.0.x が表示されることを確認

### 2.2 必要な権限設定

1. Windows実行ユーザー権限
   - ローカル管理者権限を付与

2. ネットワーク共有フォルダ権限
   - \\192.168.200.20\全社共有\SS予約表\ への読み取り権限を確認

3. ファイアウォール設定
   - Windowsファイアウォール設定で以下の通信を許可:
     - 外向き TCP/443 (HTTPS) - Supabase/LINE WORKS API用
     - 内向き/外向き SMB (TCP/445) - ファイル共有アクセス用

4. スケジュールタスク登録権限
   - Windowsタスクスケジューラへの登録権限を確認

### 2.3 認証情報の準備

以下の認証情報を暗号化シートから確認し、メモしておく：

1. Supabase認証情報
   - Supabase URL
   - Supabase API Key (service_role)

2. LINE WORKS認証情報
   - CLIENT_ID
   - BOT_ID
   - 秘密鍵 (Private Key)

## 3. インストール手順

### 3.1 インストーラの実行

1. インストールパッケージを実行
   - ReservationSync-Setup-1.0.0.msi を右クリック
   - 「管理者として実行」を選択

2. インストールウィザードの手順に従う
   - 「次へ」をクリック
   - ライセンス契約に同意
   - インストール先を確認 (デフォルト: C:\Program Files\ReservationSync)
   - インストールをクリック

3. インストール完了
   - 「初期設定ウィザードを実行する」にチェックを入れたまま「完了」をクリック

### 3.2 初期設定ウィザード

インストール完了後、自動的に起動する初期設定ウィザードで以下の設定を行う：

1. 「環境設定」タブ
   - Supabase接続情報
     - Supabase URL: [事前準備でメモしたURL]
     - API Key: [事前準備でメモしたKey]
   - LINE WORKS設定
     - Client ID: [事前準備でメモしたID]
     - Bot ID: [事前準備でメモしたID]
   - 「Windowsの資格情報に保存」ボタンをクリック

2. 「秘密鍵設定」タブ
   - 「秘密鍵インポート」ボタンをクリック
   - [事前準備でメモした秘密鍵]をテキストエリアに貼り付け
   - 「検証」ボタンをクリックして有効性を確認
   - 「保存」ボタンをクリック

3. 「監視設定」タブ
   - ネットワークパス:
     - \\192.168.200.20\全社共有\SS予約表\2025年\千葉\いいいい\【いいいい】2025年_SS予約表_*.xlsm
     - \\192.168.200.20\全社共有\SS予約表\2025年\埼京A2\ふふふふ\【ふふふふ】2025年_SS予約表_*.xlsm
     - \\192.168.200.20\全社共有\SS予約表\2025年\埼京B\みみみ\【みみみ】2025年_SS予約表_*.xlsm
   - 監視スケジュール:
     - 「午前実行」にチェック → 10:00
     - 「午後実行」にチェック → 18:00
     - 「許容時間範囲」: 15分
   - 「保存」ボタンをクリック

4. 「Excel設定」タブ
   - ワークシート名: 予約一覧
   - 対象列: BG
   - 「保存」ボタンをクリック

5. 「接続テスト」タブ
   - 「すべてテスト」ボタンをクリック
   - 各項目が「成功」と表示されることを確認
     - ネットワークパスアクセス
     - Excelファイル読込
     - Supabase接続
     - LINE WORKS接続
   - 問題がなければ「次へ」をクリック

6. 「スケジュール登録」タブ
   - 「Windowsタスクスケジューラに登録」ボタンをクリック
   - タスク実行アカウント情報を入力:
     - ユーザー名: [管理者権限を持つアカウント名]
     - パスワード: [アカウントのパスワード]
   - 「登録」ボタンをクリック
   - 「登録完了」メッセージを確認
   - 「完了」ボタンをクリック

### 3.3 フォルダ構成の確認

インストール後、以下のフォルダ構成を確認する：

1. プログラムフォルダ
   - C:\Program Files\ReservationSync\
     - ReservationSync.exe (メインプログラム)
     - ReservationSyncAdmin.exe (管理ツール)
     - 各種DLLファイル

2. データフォルダ
   - C:\ProgramData\ReservationSync\
     - config\ (設定ファイル)
     - state\ (状態ファイル)
     - proof\ (証跡ファイル)
     - logs\ (ログファイル)

## 4. 動作確認

### 4.1 手動実行テスト

1. 管理ツールを起動
   - デスクトップの「ReservationSync管理ツール」をダブルクリック
   - または、C:\Program Files\ReservationSync\ReservationSyncAdmin.exe を実行

2. 「手動実行」タブを選択
   - 「テスト実行（全拠点）」ボタンをクリック
   - 処理が開始されることを確認
   - 処理ログが表示されることを確認

3. 結果確認
   - 処理完了メッセージを確認
   - 「証跡表示」ボタンをクリックしてCSVファイルを確認
   - LINE WORKS Botにメッセージが送信されていることを確認

### 4.2 スケジュール実行確認

1. タスクスケジューラを確認
   - Windowsの「タスクスケジューラ」を開く
   - 「タスクスケジューラライブラリ」→「ReservationSync」を確認
   - トリガー設定が正しいことを確認 (10:00と18:00)

2. 次回スケジュール実行の待機
   - 次回スケジュール時刻に自動実行されることを確認
   - または、テスト目的で右クリック→「実行」で手動トリガー

3. ログの確認
   - C:\ProgramData\ReservationSync\logs\ の最新ログファイルを確認
   - 正常実行のログメッセージを確認

## 5. トラブルシューティング

### 5.1 インストール時の問題

| 問題 | 考えられる原因 | 対処法 |
|-----|-------------|------|
| インストーラが実行できない | 管理者権限がない | 右クリック→「管理者として実行」 |
| .NETエラーが表示される | .NET 6.0 Runtimeがインストールされていない | 事前準備の手順でインストール |
| 「アクセス拒否」エラー | フォルダに書き込み権限がない | アクセス権限を確認・修正 |

### 5.2 初期設定時の問題

| 問題 | 考えられる原因 | 対処法 |
|-----|-------------|------|
| Supabase接続エラー | URL/APIキーが不正、またはインターネット接続の問題 | 認証情報とインターネット接続を確認 |
| LINE WORKS接続エラー | ID/秘密鍵が不正、またはインターネット接続の問題 | 認証情報とインターネット接続を確認 |
| ネットワークパスアクセスエラー | パス不正またはアクセス権限の問題 | パス形式とアクセス権限を確認 |
| タスク登録エラー | Windowsアカウント権限の問題 | 管理者権限のあるアカウントを使用 |

### 5.3 動作確認時の問題

| 問題 | 考えられる原因 | 対処法 |
|-----|-------------|------|
| 手動実行でエラー | 各種設定の問題 | ログファイルを確認して原因特定 |
| LINE通知が届かない | Bot設定またはネットワークの問題 | 管理ツールの「テスト送信」で確認 |
| タスクが実行されない | スケジュール設定の問題 | タスクスケジューラの設定を確認 |
| Excel読み込みエラー | ファイル形式またはシート構成の問題 | Excelファイルの形式・シート名を確認 |

## 6. アンインストール方法

必要に応じて、以下の手順でアンインストールできます：

1. 事前準備
   - 管理ツールの「メンテナンス」タブで「構成バックアップ」を実行
   - タスクスケジューラからタスクを無効化または削除

2. アンインストール手順
   - Windowsの「設定」→「アプリ」→「アプリと機能」を開く
   - 「ReservationSync」を選択
   - 「アンインストール」ボタンをクリック
   - 画面の指示に従ってアンインストール

3. データファイルの扱い
   - アンインストール時にデータを保持するか選択できます
   - 必要に応じて C:\ProgramData\ReservationSync\ のデータをバックアップ

## 7. 更新履歴

| バージョン | リリース日 | 主な変更点 |
|----------|-----------|----------|
| 1.0.0 | YYYY/MM/DD | 初回リリース |

## 8. 開発者向け情報

### 8.1 macOS開発環境構築手順

本ツールは.NET 6のクロスプラットフォーム対応によりmacOS環境でも開発可能です。以下の手順でmacOS上に開発環境を構築できます。

1. .NET 6 SDKのインストール
   ```bash
   # Homebrewを使用する場合
   brew install dotnet-sdk
   
   # または公式インストーラを使用する場合
   curl -sSL https://dot.net/v1/dotnet-install.sh | bash -s -- --version 6.0.413
   ```

2. PATHの設定（curl方式でインストールした場合）
   ```bash
   export PATH=$PATH:$HOME/.dotnet:$HOME/.dotnet/tools
   ```

3. インストール確認
   ```bash
   dotnet --list-sdks
   ```

4. プロジェクト作成
   ```bash
   mkdir -p src
   cd src
   dotnet new console -n ReservationSyncTool -f net6.0
   cd ReservationSyncTool
   ```

5. 必要なパッケージのインストール
   ```bash
   dotnet add package ClosedXML
   dotnet add package Supabase
   dotnet add package Npgsql
   dotnet add package Newtonsoft.Json
   ```

6. プロジェクト構造作成
   ```bash
   mkdir -p Models Services Utils
   ```

7. 開発IDEの準備
   - Visual Studio for Mac、VS Code + C# 拡張機能、JetBrains Rider などを利用可能
   - Cursor + C#拡張機能も利用可能

**注意**: macOSでの開発は可能ですが、Windows固有の機能（Windowsタスクスケジューラなど）を使用する部分については、Windows環境で最終テストする必要があります。 